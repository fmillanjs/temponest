name: Deploy to Production

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
      rollback:
        description: 'Rollback to previous version'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/temponest

jobs:
  # Determine deployment target
  prepare:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Check if should deploy
        id: check
        run: |
          if [ "${{ inputs.rollback }}" = "true" ]; then
            echo "should_deploy=rollback" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=deploy" >> $GITHUB_OUTPUT
          fi

  # Deploy services with rolling updates
  deploy:
    needs: prepare
    if: needs.prepare.outputs.should_deploy == 'deploy'
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.prepare.outputs.environment }}
    strategy:
      max-parallel: 2  # Deploy 2 services at a time
      matrix:
        service:
          - agents
          - auth
          - scheduler
          - approval_ui
          - ingestion
          - temporal_workers
          - web_ui
          - console
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download deployment scripts
        run: |
          chmod +x scripts/deploy/*.sh

      - name: Deploy ${{ matrix.service }}
        env:
          SERVICE_NAME: ${{ matrix.service }}
          ENVIRONMENT: ${{ needs.prepare.outputs.environment }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          ./scripts/deploy/rolling-deploy.sh \
            --service ${{ matrix.service }} \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:${{ github.sha }} \
            --environment ${{ needs.prepare.outputs.environment }} \
            --health-check-timeout 300

      - name: Verify deployment
        run: |
          ./scripts/deploy/verify-deployment.sh \
            --service ${{ matrix.service }} \
            --environment ${{ needs.prepare.outputs.environment }}

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, initiating automatic rollback..."
          ./scripts/deploy/rollback.sh \
            --service ${{ matrix.service }} \
            --environment ${{ needs.prepare.outputs.environment }}

  # Manual rollback
  rollback:
    needs: prepare
    if: needs.prepare.outputs.should_deploy == 'rollback'
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.prepare.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Rollback all services
        run: |
          for service in agents auth scheduler approval_ui ingestion temporal_workers web_ui console; do
            echo "Rolling back $service..."
            ./scripts/deploy/rollback.sh \
              --service $service \
              --environment ${{ needs.prepare.outputs.environment }}
          done

  # Post-deployment checks
  post-deploy:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run smoke tests
        run: |
          ./scripts/deploy/smoke-tests.sh \
            --environment ${{ needs.prepare.outputs.environment }}

      - name: Check service health
        run: |
          ./scripts/deploy/health-check.sh \
            --environment ${{ needs.prepare.outputs.environment }} \
            --timeout 300

      - name: Notify deployment success
        if: success()
        run: |
          echo "Deployment successful!"
          echo "Environment: ${{ needs.prepare.outputs.environment }}"
          echo "Commit: ${{ github.sha }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "Deployment failed - services rolled back"
          exit 1
